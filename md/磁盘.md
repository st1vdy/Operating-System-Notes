# 磁盘

## 物理结构

<img src="../../../计算机组成原理/pics/1781px-Cylinder_Head_Sector.svg.png" alt="1781px-Cylinder_Head_Sector.svg" style="zoom: 25%;" />

磁盘的物理结构如上，下面是有关磁盘的一些名词解释：

1. **磁道（Track）**：磁盘上任意一圈被称为是磁道。
2. **柱面（Cylinder）**：磁道也被称为柱面，这是由于磁盘是一个立体结构，因此磁道其实并不是一个圆环，而是一个圆柱面。也就是说，**磁道和柱面是同一个概念**。
3. **扇区（Sector）**：每个磁道都会被划分为一系列的区域，称为扇区。
4. **磁头（Heads）**：每一个盘片对应两个磁头。
5. **盘片（Platters）**：每个碟片都有两面，因此也会相对应每碟片有2个磁头。

更详细的单个盘片内部结构图：

<img src="../../../计算机组成原理/pics/1920px-Disk-structure2.svg.png" alt="1920px-Disk-structure2.svg" style="zoom:25%;" />

1. 磁道
2. 扇面
3. 扇区
4. 簇

## 磁盘性能指标

### 磁盘容量

磁盘容量由以下技术因素决定：

- 记录密度（recording density）：磁道每一英寸可以放入的位数。
- 磁道密度（track density）：从盘片中心出发，半径上每一英寸的段内可以有的磁道数。
- 面密度（areal density）：记录密度与磁道密度的乘积。

*磁盘上每条磁道存储的信息量与长度无关，也就是说磁道越长，记录密度越小。

*国内教材上，记录密度也称为**位密度**，磁道密度也称为**道密度**。

### 平均存取时间

平均存取时间=（磁盘控制器延迟）+寻道时间（磁头移动到目的磁道）+旋转延迟时间（磁头定位到所在扇区，如果没有特殊声明，就取平均值【转半圈】）+传输时间（传输数据所花费的时间）

<img src="../../../计算机组成原理/pics/harddiskp1.png" alt="harddiskp1" style="zoom:50%;" />

### 数据传输率

数据传输率就是磁盘在单位时间内向主机传输的数据量（字节数）。假设磁盘转速为 $r转/秒$，每条磁道的容量为 $N$ 个字节，则数据传输率为 $D_r=rN$。



## 磁盘调度

磁盘调度算法是指：当硬盘接收到一连串需要访问的磁道请求时，如何按照一定顺序安排访问磁道的顺序。

### 先来先服务(FCFS)

字面意思。

### 最短寻道时间优先(SSTF)

**最短寻道时间优先(Shortest-Seek-Time-First)**算法就是贪心算法，在每次磁道访问结束后，寻找距离当前位置最近的待访问磁道。

- SSTF有一个明显的缺点：可能产生饥饿。

### SCAN

**扫描算法(SCAN algorithm)**就是磁头从磁道的一端开始向另一端移动，将扫描路径上的所有访问请求都顺路处理；当抵达另一端后再反向扫描，并处理路径上的请求。

### C-SCAN

**循环扫描(Circular-SCAN)**

与SCAN算法不同的是，**C-SCAN在磁头到达另一端后返回，但是不处理路径上的请求**。

### LOOK

SCAN算法的一个问题是当磁头向一端移动时，如果已经处理完了这个方向上全部的请求，再向后移动到端点的过程就是无效运动。LOOK算法的改进就是当处理完了运动方向上的所有访问请求之后，磁头的运动方向就会立即反向。

同理，C-SCAN也可以优化为C-LOOK。

## 性能提升

### 交替编号

由于磁头读完数据后需要一定的时间处理数据，因此如果一个文件在磁盘中分配的扇区是连续的，就会导致磁头在连续读取一个文件的数据时虽然需要扫描的扇区在物理空间上连续，却需要花费更多的时间（读了一个扇区后需要花费一定时间处理，但是磁盘的旋转是不会停止的，这就会导致磁头转过头）。

这个问题的一个解决方案就是磁盘扇区的编号不是按照顺序分配，而是交替分配。

### 物理编址

磁盘由多个盘面组成，因此相同的文件可以分配到**不同盘面中的相同柱面**中（而不是简单地将物理文件放在一个盘面的不同柱面中），这样磁盘就可以减少磁头的移动次数。

在具体实现中，由于磁盘的物理寻址需要盘面号，柱面号，扇区号，我们可以采用 `柱面号 + 盘面号 + 扇区号` 的编码方式编址。

> 举例论证：假设一个文件需要16个扇区，磁盘中有2个盘面，每个盘面有8个柱面，1个柱面里有8个扇区。
>
> 如果采用了 `柱面号 + 盘面号 + 扇区号` 的编码方式编址，那么柱面号占3位，盘面号占1位，扇区号占3位，例如 `000 1 010` 就表示1号盘面0号磁道中的2号扇区。由于这个文件需要16个扇区，也就是说可能拿走这些扇区：`000 0 000 - 000 1 111`，此时我们不难发现这些扇区恰好占据了不同盘面中的相同柱面，因此磁头不需要移动到其他柱面就能完成文件的访问。
>
> 但是如果采用了 `盘面号 + 柱面号 + 扇区号` 的编码方式编址就至少需要1次磁头移动到其他的磁道。

### 盘面交错编号

在采用了交替编号之后，一个由8个扇区构成的柱面可以是这样的：`0 4 1 5 2 6 3 7`，容易注意到**如果磁盘旋转一周，这种方法最多只能读取一般的扇区**（因为一定是顺序读取1，2，3……）。此时如果我们再加入一个盘面，这个盘面对应的某个柱面不需要也像前一个盘面那样编号，而是可以交错编号，例如：`4 0 5 1 6 2 7 3`。这么做可以使得两个盘面之间的编号恰好完全错开，提升效率。



## 磁盘管理

### 初始化

磁盘生产出来后实际上只有磁道，并没有划分扇区，因此需要初始化：

1. 进行**低级格式化（物理格式化）**，将磁盘中的各个磁道划分为扇区。扇区一般由头、数据区和尾三个部分构成，其中头、尾部包含管理扇区的信息，例如磁盘校验码（用于检测扇区内数据是否出错）。
2. 磁盘分区，每个分区由一些柱面构成（也就是将磁盘在逻辑上划分为C盘、D盘等）。
3. 进行**逻辑格式化**，创建文件系统。包括创建文件系统的根目录、初始化存储空间管理所用的数据结构（位向量、空闲分区表等）等。

### 引导块

### 坏块

磁盘会维护磁盘内损坏的磁盘块，并且预留一些块保留作为备用。

对于简单的磁盘，可以在逻辑格式化时检查坏块然后标明这些损坏的扇区（比如在FAT上标记）。这种方式中，坏块对操作系统不可见。对于复杂的磁盘，磁盘通过一个内部硬件“磁盘控制器”维护坏块的表，这种方式下坏块对操作系统可见。



## 例题

> 假设磁头当前位于第105道，正在向磁道序号增加的方向移动，现有一个磁道访问请求序列为 `35,45,12,68,110,180,170,195`，采用SCAN调度（电梯调度）算得到的磁道访问序列是（ ）

`110,170,180,195,68,45,35,12`。



> 某硬盘有 200 个磁道（最外侧磁道号为 0），磁道访问请求序列为：`130,42,180,15,199`，当前磁头位于第 58 号磁道并从外侧向内侧移动。按照 SCAN 调度方法处理完上述请求后，磁头移过的磁道数是（）

磁头从外侧向内侧移动，所以是 `58->199->15`，总共移过了325个磁道。



> 下列选项中，磁盘逻辑格式化程序所做的工作是（）
>
> 1. 对磁盘进行分区
> 2. 建立文件系统的根目录
> 3. 确定磁盘扇区校验码所占位数
> 4. 对保存空闲磁盘块信息的数据结构进行初始化

这里说的是磁盘的逻辑格式化，也就是建立文件系统，因此选项2，4正确。



> 某文件系统的簇和磁盘扇区大小分别为1KB和512B。若一个文件的大小为1026B，则系统分配给该文件的磁盘空间大小是（）。

文件系统分配空间以磁盘块为单位，但是本题中说明了文件系统采用了簇，因此分配空间的基本单位是簇，所以一个1026B的文件需要两个簇，即系统分配给该文件的磁盘空间大小是2KB.



> 系统总是访问磁盘的某个磁道而不响应对其他磁道的访问请求，这种现象称为磁臂黏着。下列磁盘调度算法中，不会导致磁臂黏着的是（）
>
> 1. 先来先服务（FCFS）
> 2. 最短寻道时间优先（SSTF）
> 3. 扫描算法（SCAN）
> 4. 循环扫描算法（CSCAN）

选项1正确。选项3、4错误的原因是类似的，例如访问序号为 `10 1 10 10 10 10 ...`，且磁头正好在10，那么柱面1可能一直无法响应。

